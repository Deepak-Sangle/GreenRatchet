generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

generator zod {
  provider = "prisma-zod-generator"
  config   = "../zod-generator.config.json"
}

datasource db {
  provider = "postgresql"
}

model User {
  id             String        @id @default(cuid())
  name           String?
  email          String        @unique
  // emailVerified  DateTime?
  password       String
  image          String?
  role           UserRole
  organizationId String?
  lastLoginAt    DateTime?     @default(now())
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  avatarUrl      String?
  auditLogs      AuditLog[]
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([email])
}

model Organization {
  id               String            @id @default(cuid())
  name             String
  type             UserRole
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  logoUrl          String?
  headquarters     String?
  linkedinUrl      String?
  annualRevenue    Float?
  employeeCount    Int?
  auditLogs        AuditLog[]
  cloudConnections CloudConnection[]
  kpis             KPI[]
  users            User[]
}

model KPI {
  id             String            @id @default(cuid())
  name           String
  targetValue    Float
  baselineValue  Float?
  organizationId String
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  direction      KpiDirection
  effectiveFrom  DateTime
  effectiveTo    DateTime?
  thresholdMax   Float?
  thresholdMin   Float?
  type           KpiType
  frequency      ObservationPeriod
  auditLogs      AuditLog[]
  organization   Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  results        KPIResult[]
}

model KPIResult {
  id          String          @id @default(cuid())
  kpiId       String
  periodStart DateTime
  periodEnd   DateTime
  actualValue Float
  targetValue Float
  status      KPIResultStatus @default(PENDING)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  auditLogs   AuditLog[]
  kpi         KPI             @relation(fields: [kpiId], references: [id], onDelete: Cascade)
}

model CloudConnection {
  id                String           @id @default(cuid())
  provider          CloudProvider
  // for aws cloud formation stack
  roleArn           String?
  externalId        String?
  // for gcp
  serviceAccountKey String?
  projectId         String?
  // for azure
  tenantId          String?
  isActive          Boolean          @default(true)
  lastSync          DateTime?
  organizationId    String
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  accountId         String?
  auditLogs         AuditLog[]
  organization      Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  footprintData     CloudFootprint[]
}

model CloudFootprint {
  id                String             @id @default(cuid())
  cloudConnectionId String
  cloudProvider     String
  kilowattHours     Float?
  co2e              Float
  cost              Float?
  serviceName       String
  region            String
  tags              String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  timestamp         DateTime
  periodStartDate   DateTime
  periodEndDate     DateTime
  type              CloudFootprintType @default(OPERATIONAL_METRICS)
  serviceType       String?
  cloudConnection   CloudConnection    @relation(fields: [cloudConnectionId], references: [id], onDelete: Cascade)

  @@index([cloudConnectionId])
  @@index([periodStartDate, periodEndDate])
  @@index([serviceName])
}

model AuditLog {
  id                String           @id @default(cuid())
  action            String
  entity            String
  entityId          String
  details           String
  userId            String?
  kpiId             String?
  kpiResultId       String?
  cloudConnectionId String?
  createdAt         DateTime         @default(now())
  organizationId    String?
  cloudConnection   CloudConnection? @relation(fields: [cloudConnectionId], references: [id], onDelete: Cascade)
  kpi               KPI?             @relation(fields: [kpiId], references: [id], onDelete: Cascade)
  kpiResult         KPIResult?       @relation(fields: [kpiResultId], references: [id], onDelete: Cascade)
  organization      Organization?    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user              User?            @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model GridCarbonFreeEnergy {
  id                  String                  @id @default(cuid())
  zone                String
  dataCenterRegion    String
  dataCenterProvider  ElectricityMapsProvider
  datetime            DateTime
  value               Float
  isEstimated         Boolean
  apiUpdatedAt        DateTime
  apiCreatedAt        DateTime
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt
  estimationMethod    String?
  temporalGranularity String?

  @@unique([dataCenterRegion, dataCenterProvider, datetime])
  @@index([dataCenterRegion, dataCenterProvider])
  @@index([datetime])
}

model GridRenewableEnergy {
  id                  String                  @id @default(cuid())
  zone                String
  dataCenterRegion    String
  dataCenterProvider  ElectricityMapsProvider
  datetime            DateTime
  value               Float
  isEstimated         Boolean
  apiUpdatedAt        DateTime
  apiCreatedAt        DateTime
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt
  estimationMethod    String?
  temporalGranularity String?

  @@unique([dataCenterRegion, dataCenterProvider, datetime])
  @@index([dataCenterRegion, dataCenterProvider])
  @@index([datetime])
}

model GridCarbonIntensity {
  id                  String                  @id @default(cuid())
  zone                String
  dataCenterRegion    String
  dataCenterProvider  ElectricityMapsProvider
  datetime            DateTime
  emissionFactorType  String
  isEstimated         Boolean
  apiUpdatedAt        DateTime
  apiCreatedAt        DateTime
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt
  estimationMethod    String?
  temporalGranularity String?
  value               Float

  @@unique([dataCenterRegion, dataCenterProvider, datetime])
  @@index([dataCenterRegion, dataCenterProvider])
  @@index([datetime])
}

model GridCarbonIntensityFossilOnly {
  id                  String                  @id @default(cuid())
  zone                String
  dataCenterRegion    String
  dataCenterProvider  ElectricityMapsProvider
  datetime            DateTime
  emissionFactorType  String
  isEstimated         Boolean
  estimationMethod    String?
  temporalGranularity String?
  apiUpdatedAt        DateTime
  apiCreatedAt        DateTime
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt
  value               Float

  @@unique([dataCenterRegion, dataCenterProvider, datetime])
  @@index([dataCenterRegion, dataCenterProvider])
  @@index([datetime])
}

model GridElectricityMix {
  id                  String                  @id @default(cuid())
  zone                String
  dataCenterRegion    String
  dataCenterProvider  ElectricityMapsProvider
  datetime            DateTime
  nuclear             Float
  geothermal          Float
  biomass             Float
  coal                Float
  wind                Float
  solar               Float
  hydro               Float
  gas                 Float
  oil                 Float
  unknown             Float
  hydroDischarge      Float
  batteryDischarge    Float
  isEstimated         Boolean
  apiUpdatedAt        DateTime
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt
  estimationMethod    String?
  temporalGranularity String?

  @@unique([dataCenterRegion, dataCenterProvider, datetime])
  @@index([dataCenterRegion, dataCenterProvider])
  @@index([datetime])
}

enum UserRole {
  BORROWER
  LENDER
}

enum CloudProvider {
  AWS
  GCP
  AZURE
}

enum KPIResultStatus {
  PASSED
  FAILED
  PENDING
}

enum CloudServiceSource {
  OPERATIONAL_METRICS
  EMBODIED_METRICS
}

enum ObservationPeriod {
  ANNUAL
  QUARTERLY
  MONTHLY
}

enum KpiType {
  CO2_EMISSION
  AI_COMPUTE_HOURS
  LOW_CARBON_REGION_PERCENTAGE
  CARBON_FREE_ENERGY_PERCENTAGE
  ELECTRICITY_MIX_BREAKDOWN
  RENEWABLE_ENERGY_PERCENTAGE
  ENERGY_CONSUMPTION
  WATER_WITHDRAWAL
  GHG_INTENSITY
  WATER_STRESSED_REGION_PERCENTAGE
}

enum KpiDirection {
  LOWER_IS_BETTER
  HIGHER_IS_BETTER
}

enum CloudFootprintType {
  OPERATIONAL_METRICS
  EMBODIED_METRICS
}

enum ElectricityMapsProvider {
  AWS
  AZURE
  GCP
}
