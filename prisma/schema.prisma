generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  BORROWER
  LENDER
}

enum KPIStatus {
  PROPOSED
  ACCEPTED
  REJECTED
}

enum CloudProvider {
  AWS
  GCP
  AZURE
}

enum KPIResultStatus {
  PASSED
  FAILED
  PENDING
}

model User {
  id             String        @id @default(cuid())
  name           String?
  email          String        @unique
  emailVerified  DateTime?
  password       String
  image          String?
  role           UserRole
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  auditLogs      AuditLog[]
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
}

model Organization {
  id               String            @id @default(cuid())
  name             String
  type             UserRole
  users            User[]
  borrowerLoans    Loan[]            @relation("BorrowerOrganization")
  lenderLoans      Loan[]            @relation("LenderOrganization")
  cloudConnections CloudConnection[]
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
}

model Loan {
  id                String        @id @default(cuid())
  name              String
  currency          String        @default("USD")
  observationPeriod String // e.g., "Annual", "Quarterly"
  marginRatchetBps  Int // Basis points for margin adjustment
  borrowerOrgId     String
  borrowerOrg       Organization  @relation("BorrowerOrganization", fields: [borrowerOrgId], references: [id])
  lenderOrgId       String?
  lenderOrg         Organization? @relation("LenderOrganization", fields: [lenderOrgId], references: [id])
  kpis              KPI[]
  auditLogs         AuditLog[]
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
}

model KPI {
  id                String      @id @default(cuid())
  name              String
  definition        String      @db.Text
  metricFormula     String      @db.Text
  unit              String // e.g., "tCOâ‚‚e / 1,000 AI compute hours", "%"
  targetValue       Float
  baselineValue     Float?
  observationPeriod String
  marginImpactBps   Int // Basis points impact (+/-)
  status            KPIStatus   @default(PROPOSED)
  loanId            String
  loan              Loan        @relation(fields: [loanId], references: [id], onDelete: Cascade)
  results           KPIResult[]
  auditLogs         AuditLog[]
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
}

model KPIResult {
  id                 String          @id @default(cuid())
  kpiId              String
  periodStart        DateTime
  periodEnd          DateTime
  actualValue        Float
  targetValue        Float
  status             KPIResultStatus @default(PENDING)
  // Calculation metadata
  dataSource         String          @db.Text // JSON string of data sources
  calculationDetails String          @db.Text // JSON string of calculation steps
  calculationVersion String
  kpi                KPI             @relation(fields: [kpiId], references: [id], onDelete: Cascade)
  auditLogs          AuditLog[]
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
}

model CloudConnection {
  id                String        @id @default(cuid())
  provider          CloudProvider
  // AWS specific
  roleArn           String?
  externalId        String?
  // GCP specific
  serviceAccountKey String?       @db.Text
  projectId         String?
  // Common
  isActive          Boolean       @default(true)
  lastSync          DateTime?
  organizationId    String
  organization      Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  auditLogs         AuditLog[]
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
}

model AuditLog {
  id                String           @id @default(cuid())
  action            String // e.g., "KPI_CREATED", "KPI_ACCEPTED", "DATA_PULL", "RESULT_CHANGED"
  entity            String // e.g., "KPI", "LOAN", "CLOUD_CONNECTION"
  entityId          String
  details           String           @db.Text // JSON string
  userId            String?
  user              User?            @relation(fields: [userId], references: [id])
  loanId            String?
  loan              Loan?            @relation(fields: [loanId], references: [id])
  kpiId             String?
  kpi               KPI?             @relation(fields: [kpiId], references: [id])
  kpiResultId       String?
  kpiResult         KPIResult?       @relation(fields: [kpiResultId], references: [id])
  cloudConnectionId String?
  cloudConnection   CloudConnection? @relation(fields: [cloudConnectionId], references: [id])
  createdAt         DateTime         @default(now())
}
