generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

generator zod {
  provider = "prisma-zod-generator"
  config   = "../zod-generator.config.json"
}

enum UserRole {
  BORROWER
  LENDER
}

enum KPIStatus {
  PROPOSED
  ACCEPTED
  REJECTED
}

enum CloudProvider {
  AWS
  GCP
  AZURE
}

enum KPIResultStatus {
  PASSED
  FAILED
  PENDING
}

enum LoanStatus {
  PENDING
  ACTIVE
  CLOSED
}

enum LoanType {
  FIXED_RATE // The interest rate is fixed for the entire loan term
  FLOATING_RATE // The interest rate is variable and changes based on market conditions
  AMORTIZED // The loan is amortized over the loan term
  ANNUITY // The loan is repaid in equal installments over the loan term
  BALLOON // The loan is repaid in a single lump sum at the end of the loan term
  CREDIT_LINE // The loan is a credit line that can be used as needed
  REVOLVING_CREDIT_LINE // The loan is a revolving credit line that can be used as needed
  CREDIT_CARD // The loan is a credit card that can be used as needed
}

model User {
  id             String        @id @default(cuid())
  name           String?
  avatarUrl      String?
  email          String        @unique
  emailVerified  DateTime?
  password       String
  image          String?
  role           UserRole
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  auditLogs      AuditLog[]
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  loans          Loan[]
}

model Organization {
  id               String            @id @default(cuid())
  name             String
  logoUrl          String?
  // all users in this organization have the same role
  // but they are still have the field `role` in the user table
  type             UserRole
  users            User[]
  borrowerLoans    Loan[]            @relation("BorrowerOrganization")
  lenderLoans      Loan[]            @relation("LenderOrganization")
  cloudConnections CloudConnection[]
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
}

enum LoanCurrency {
  USD
  EUR
  GBP
  JPY
  AUD
  CAD
  CHF
}

enum ObservationPeriod {
  ANNUAL
  QUARTERLY
  MONTHLY
}

model Loan {
  id                String            @id @default(cuid())
  name              String
  currency          LoanCurrency      @default(USD)
  // The period interval for which the loan will be observed to adjust the margin
  observationPeriod ObservationPeriod
  // The basis points for margin ratchet; 1 bps = 0.01%
  // If during the observation period, the KPI result is below the target value, the margin will be adjusted (decreased) by the margin ratchet bps, otherwise increased
  marginRatchetBps  Int               @default(0)
  // I have no idea what these are, but since our app doesn't handle loan calculations, we are gonna add them
  // Use -1 to indicate that the value is N/A
  // At least one of these three should be set
  principalAmount   Float
  committedAmount   Float
  drawnAmount       Float
  type              LoanType          @default(FIXED_RATE)
  borrowerOrgId     String
  borrowerOrg       Organization      @relation("BorrowerOrganization", fields: [borrowerOrgId], references: [id])
  lenderOrgId       String?
  lenderOrg         Organization?     @relation("LenderOrganization", fields: [lenderOrgId], references: [id])
  startDate         DateTime
  maturityDate      DateTime
  status            LoanStatus        @default(PENDING)
  // All the KPIs for this loan
  kpis              KPI[]
  auditLogs         AuditLog[]
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  createdByUserId   String
  createdByUser     User              @relation(fields: [createdByUserId], references: [id])
}

model KPI {
  id                String            @id @default(cuid())
  name              String
  definition        String            @db.Text
  metricFormula     String            @db.Text
  unit              String // e.g., "tCOâ‚‚e / 1,000 AI compute hours", "%"
  targetValue       Float
  baselineValue     Float?
  observationPeriod ObservationPeriod
  marginImpactBps   Int // Basis points impact (+/-)
  status            KPIStatus         @default(PROPOSED)
  loanId            String
  loan              Loan              @relation(fields: [loanId], references: [id], onDelete: Cascade)
  results           KPIResult[]
  auditLogs         AuditLog[]
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
}

model KPIResult {
  id                 String          @id @default(cuid())
  kpiId              String
  periodStart        DateTime
  periodEnd          DateTime
  actualValue        Float
  targetValue        Float
  status             KPIResultStatus @default(PENDING)
  // Calculation metadata
  dataSource         String          @db.Text // JSON string of data sources
  calculationDetails String          @db.Text // JSON string of calculation steps
  calculationVersion String
  kpi                KPI             @relation(fields: [kpiId], references: [id], onDelete: Cascade)
  auditLogs          AuditLog[]
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
}

model CloudConnection {
  id                String        @id @default(cuid())
  provider          CloudProvider
  // AWS specific
  roleArn           String?
  externalId        String?
  // GCP specific
  serviceAccountKey String?       @db.Text
  projectId         String?
  // Common
  isActive          Boolean       @default(true)
  lastSync          DateTime?
  organizationId    String
  organization      Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  auditLogs         AuditLog[]
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
}

model AuditLog {
  id                String           @id @default(cuid())
  action            String // e.g., "KPI_CREATED", "KPI_ACCEPTED", "DATA_PULL", "RESULT_CHANGED"
  entity            String // e.g., "KPI", "LOAN", "CLOUD_CONNECTION"
  entityId          String
  details           String           @db.Text // JSON string
  userId            String?
  user              User?            @relation(fields: [userId], references: [id])
  loanId            String?
  loan              Loan?            @relation(fields: [loanId], references: [id])
  kpiId             String?
  kpi               KPI?             @relation(fields: [kpiId], references: [id])
  kpiResultId       String?
  kpiResult         KPIResult?       @relation(fields: [kpiResultId], references: [id])
  cloudConnectionId String?
  cloudConnection   CloudConnection? @relation(fields: [cloudConnectionId], references: [id])
  createdAt         DateTime         @default(now())
}
